<div class="filelist-header">
    <h1>üìÇ Uploaded Files</h1>

    {{!-- Reset Sort button --}}
    {{#if (or sort dir)}}
        <a class="reset-sort-btn" href="{{buildQueryUrl '/files' (mergeQuery query 'sort' '' 'dir' '')}}">
            Reset Sort
        </a>
    {{/if}}

    {{!-- Filter / Search Form --}}
    <form method="GET" action="/files" class="filter-bar">
        <input type="text" name="search" placeholder="Search by name" value="{{query.search}}">

        <select name="type">
            <option value="all">All Types</option>
            <option value="image" {{#ifEq (toLower query.type) "image"}}selected{{/ifEq}}>Images</option>
            <option value="pdf" {{#ifEq (toLower query.type) "pdf"}}selected{{/ifEq}}>PDFs</option>
            <option value="doc" {{#ifEq (toLower query.type) "doc"}}selected{{/ifEq}}>Documents</option>
        </select>

        <button type="submit">Filter</button>
        <a href="/files" class="reset">Reset</a>

        {{!-- Preserve sort and per-page --}}
        <input type="hidden" name="sort" value="{{sort}}">
        <input type="hidden" name="dir" value="{{dir}}">
        <input type="hidden" name="limit" value="{{limit}}">
    </form>
</div>

{{#if files.length}}

    <!-- Results per page selector -->
    <div class="pagination-controls">
        <label for="perPage">Show:</label>
        <select id="perPage" onchange="changeLimit(this.value)">
            {{#each perPageOptions}}
                <option value="{{this}}" {{#if (ifEq ../limit this)}}selected{{/if}}>{{this}}</option>
            {{/each}}
        </select>
    </div>
    <div class="meta-toggle-all">
        <button type="button" id="toggle-all-btn">Expand All Metadata</button>
    </div>

    <!-- File list table -->
    <table class="file-list">
        <thead>
            <tr>
                <th class="col-preview">Preview</th>
                <th class="col-name-orig">
                    <a href="{{buildQueryUrl '/files' (mergeQuery query 'sort' 'originalName' 'dir' (nextDir sort dir 'originalName'))}}">
                        Original Name {{sortArrow sort dir 'originalName'}}
                    </a>
                </th>
                <th class="col-name-stored">
                    <a href="{{buildQueryUrl '/files' (mergeQuery query 'sort' 'filename' 'dir' (nextDir sort dir 'filename'))}}">
                        Stored Name {{sortArrow sort dir 'filename'}}
                    </a>
                </th>
                <th class="col-type">
                    <a href="{{buildQueryUrl '/files' (mergeQuery query 'sort' 'mimetype' 'dir' (nextDir sort dir 'mimetype'))}}">
                        Type {{sortArrow sort dir 'mimetype'}}
                    </a>
                </th>
                <th class="col-size">
                    <a href="{{buildQueryUrl '/files' (mergeQuery query 'sort' 'size' 'dir' (nextDir sort dir 'size'))}}">
                        Size (KB) {{sortArrow sort dir 'size'}}
                    </a>
                </th>
                <th class="col-project">
                    <a href="{{buildQueryUrl '/files' (mergeQuery query 'sort' 'project' 'dir' (nextDir sort dir 'project'))}}">
                        Project {{sortArrow sort dir 'project'}}
                    </a>
                </th>
                <th class="col-uploaded">
                    <a href="{{buildQueryUrl '/files' (mergeQuery query 'sort' 'uploadedAt' 'dir' (nextDir sort dir 'uploadedAt'))}}">
                        Uploaded {{sortArrow sort dir 'uploadedAt'}}
                    </a>
                </th>
                <th class="col-actions">Actions</th>
            </tr>
        </thead>
        <tbody>
            {{#each files}}
                <tr class="file-row" data-file-id="{{_id}}">
                    <td class="col-preview">
                        {{#if (ifEq (fileTypeLabel mimetype) "Image")}}
                            <img src="{{url}}" alt="{{originalName}}" width="80" />
                        {{else}}
                            <span class="file-icon">üìÑ</span>
                        {{/if}}
                    </td>
                    <td class="col-name-orig" title="{{originalName}}">{{truncate originalName 15}}</td>
                    <td class="col-name-stored" title="{{filename}}">{{truncate filename 15}}</td>
                    <td class="col-type">{{fileTypeLabel mimetype}}</td>
                    <td class="col-size">{{formatKB size}}</td>
                    <td class="col-project">{{project}}</td>
                    <td class="col-uploaded">{{formatDate uploadedAt}}</td>
                    <td class="col-actions">
                        <button type="button" class="meta-toggle-btn" data-target="{{_id}}">‚ÑπÔ∏è</button>
                        <button type="button" class="delete-btn" data-id="{{_id}}">üóëÔ∏è</button>
                    </td>
                </tr>

                <tr id="meta-{{_id}}" class="meta-row">
                    <td colspan="8">
                        <div class="meta-content">
                            <div class="meta-grid">
                                <div><strong>Uploaded By:</strong>
                                    <span class="{{#unless uploadedBy}}placeholder{{/unless}}">
                                        {{#if uploadedBy}}{{uploadedBy}}{{else}}superuser{{/if}}
                                    </span>
                                </div>
                                <div><strong>Project:</strong>
                                    <span class="{{#unless project}}placeholder{{/unless}}">
                                        {{#if project}}{{project}}{{else}}cms{{/if}}
                                    </span>
                                </div>
                                <div><strong>Instance:</strong>
                                    <span class="{{#unless instance}}placeholder{{/unless}}">
                                        {{#if instance}}{{instance}}{{else}}main{{/if}}
                                    </span>
                                </div>
                                <div><strong>Category:</strong>
                                    <span class="{{#unless category}}placeholder{{/unless}}">
                                        {{#if category}}{{category}}{{else}}none{{/if}}
                                    </span>
                                </div>
                                <div><strong>Organisation:</strong>
                                    <span class="{{#unless organisation}}placeholder{{/unless}}">
                                        {{#if organisation}}{{organisation}}{{else}}default{{/if}}
                                    </span>
                                </div>
                                <div><strong>Safe Filename:</strong>
                                    <span class="{{#unless safeFilename}}placeholder{{/unless}}">
                                        {{#if safeFilename}}{{safeFilename}}{{else}}N/A{{/if}}
                                    </span>
                                </div>
                                <div><strong>Path:</strong>
                                    <span class="{{#unless path}}placeholder{{/unless}}">
                                        {{#if path}}{{path}}{{else}}N/A{{/if}}
                                    </span>
                                </div>
                                <div><strong>Hash:</strong>
                                    <span class="{{#unless hash}}placeholder{{/unless}}">
                                        {{#if hash}}{{hash}}{{else}}N/A{{/if}}
                                    </span>
                                </div>
                                <div><strong>Detected Type:</strong>
                                    <span class="{{#unless detectedType}}placeholder{{/unless}}">
                                        {{#if detectedType}}{{detectedType}}{{else}}Other{{/if}}
                                    </span>
                                </div>
                                <div><strong>Encoding:</strong>
                                    <span class="{{#unless encoding}}placeholder{{/unless}}">
                                        {{#if encoding}}{{encoding}}{{else}}binary{{/if}}
                                    </span>
                                </div>
                                <div><strong>Dimensions:</strong>
                                    <span class="{{#unless dimensions}}placeholder{{/unless}}">
                                        {{#if dimensions}}{{dimensions}}{{else}}N/A{{/if}}
                                    </span>
                                </div>
                                <div><strong>Stored URL:</strong>
                                    <a href="{{url}}" target="_blank">{{url}}</a>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>





            {{/each}}
        </tbody>
    </table>

    <!-- Pagination links -->
    {{#if (gt totalPages 1)}}
        <nav class="pagination">
            {{#each (range 1 totalPages)}}
                <a href="{{buildQueryUrl '/files' (mergeQuery ../query 'page' this)}}" class="{{#if (ifEq this ../currentPage)}}active{{/if}}">
                    {{this}}
                </a>
            {{/each}}
        </nav>
    {{/if}}

{{else}}
    <p>No files have been uploaded yet.</p>
{{/if}}
<script type="module" src="/js/filelist.js"></script>
